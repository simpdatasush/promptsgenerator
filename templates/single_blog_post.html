<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.title }} - SuperPrompter AI Prompt Generator & Blogs</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="style.css">
    
</head>
<body>

    <header class="app-header">
        <div class="logo-section">
            <img src="https://placehold.co/40x40/007bff/ffffff?text=AI" alt="SuperPrompter Logo" class="app-logo">
            <h1 class="header-title">SuperPrompter</h1>
        </div>
        <nav class="auth-section">
            <a href="/">Home</a>
            <a href="/all_news">News</a>
            <a href="/login">Login</a>
        </nav>
    </header>

    <div class="container mt-4 post-container">
    <div class="row">
        
        {# --- LEFT COLUMN: SIDEBAR (LATEST BLOGS) --- #}
        <div class="col-md-3 d-none d-md-block">
            <div class="sidebar-widget">
                <h4 class="sidebar-title" id="sidebar-header">Latest Blogs</h4>
                
                <div id="ai-loader" class="mb-2" style="display:none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="small text-muted ml-1">AI searching...</span>
                </div>

                <ul class="list-unstyled" id="sidebar-list">
                    {% for item in latest_blogs %}
                        <li>
                            <a href="{{ item.url }}" class="sidebar-link {% if item.id == post.id %}active-link{% endif %}">
                                {{ item.title | truncate(45) }}
                            </a>
                        </li>
                    {% else %}
                        <li><p class="text-muted">No other blogs available.</p></li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        {# --- RIGHT COLUMN: MAIN BLOG CONTENT --- #}
        <div class="col-md-9">
            <div class="post-container-main"> 
                
                {# 1. Title #}
                <h1 class="post-title">{{ post.title }}</h1>
                
                {# 2. AI Topics Stripline (Merged here for correct structure) #}
                <div class="ai-keyword-stripline py-2 mb-4 border-top border-bottom" style="background: #fafafa; margin-left: -40px; margin-right: -40px; padding-left: 40px;">
                    <div class="d-flex align-items-center">
                        <span class="text-muted small font-weight-bold text-uppercase mr-3" style="letter-spacing: 1px;">
                            <i class="fas fa-microchip text-primary"></i> AI Topics:
                        </span>
                        <div class="d-flex flex-wrap">
                            {% for tag in ai_tags %}
                                <span class="mr-3 small text-dark" style="font-family: 'Courier New', Courier, monospace;">
                                    <span class="text-primary">#</span>{{ tag }}
                                </span>
                            {% else %}
                                <span class="text-muted small">Analyzing content...</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                {{# 3. Meta Data & Action Buttons #}
<div class="post-meta-strip d-flex flex-column gap-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="post-meta">
            Published: {{ post.timestamp.strftime('%B %d, %Y') if post.timestamp else 'N/A' }} 
            {% if post.user %} | By: {{ post.user.username }} {% endif %}
        </div>
        
        <div class="d-flex gap-2">
            {# --- TTS BUTTON --- #}
            <button id="tts-btn" class="btn btn-sm btn-primary rounded-pill px-3" onclick="handleTTS()">
                <i id="tts-icon" class="fas fa-volume-up mr-1"></i>
                <span id="tts-text">Listen to Post</span>
            </button>

            {# --- EXISTING COPY BUTTON --- #}
            <button id="copy-link-btn" 
                    data-url="{{ url_for('view_blog_content', blog_uuid=post.url.split('/')[-1], _external=True) }}"
                    class="btn btn-sm btn-secondary rounded-pill px-3">
                <i class="fas fa-copy"></i> Copy Link
            </button>
        </div>
    </div>

    {# --- AUDIO PROGRESS BAR (Hidden until ignited) --- #}
    <div id="audio-controls" class="p-2 bg-light rounded shadow-sm" style="display: none; border: 1px solid #ddd;">
        <div class="d-flex align-items-center gap-3">
            <span id="current-time" class="small text-muted font-weight-bold">0:00</span>
            <input type="range" id="audio-progress" value="0" max="100" class="flex-grow-1">
            <span id="duration" class="small text-muted font-weight-bold">0:00</span>
        </div>
    </div>

    <audio id="blog-audio" onended="resetTTSUI()"></audio>
</div>
                
                
                {# 4. Actual Blog Content #}
                <div class="post-content">
                    {{ post.description | safe }}
                </div>

                <hr class="my-5">

                {# --- AI HUB (Analyzers and Polls) --- #}
                <div class="ai-hub-wrapper">
                    <div class="card ai-card shadow-sm border-0 mb-4" style="border-left: 5px solid var(--color-secondary) !important;">
                        <div class="card-body p-4">
                            <h5 class="card-title text-primary"><i class="fas fa-brain"></i> AI Post-Analyzer</h5>
                            <p class="small text-muted mb-3">Instant summary and key takeaways.</p>
                            <button id="analyze-btn" class="btn btn-outline-primary btn-sm mb-3">Analyze Post</button>
                            <div id="analysis-result" class="p-3 bg-light rounded" style="display:none; white-space: pre-wrap; font-size: 0.95rem;"></div>
                        </div>
                    </div>

                    <div class="card ai-card shadow-sm border-0 mb-5" style="border-left: 5px solid var(--color-primary) !important;">
                        <div class="card-body p-4">
                            <h5 class="card-title" style="color: var(--color-primary);"><i class="fas fa-vote-yea"></i> AI Interactive Poller</h5>
                            <p class="small text-muted mb-3">Where do you stand vs. the AI's 2025 data?</p>
                            <button id="poll-gen-btn" class="btn btn-sm btn-primary mb-3">Generate AI Poll</button>
                            <div id="poll-area" style="display:none;">
                                <h6 id="poll-question" class="font-weight-bold mb-3"></h6>
                                <div id="poll-options-container" class="d-flex flex-column gap-2 mb-3"></div>
                            </div>
                            <div id="smart-answer-box" class="mt-4 p-4 rounded shadow-sm" style="display:none; background-color: #f8fff9; border: 1px solid #d4edda;">
                                <strong class="d-block mb-2 text-success"><i class="fas fa-robot"></i> AI Stance Review:</strong>
                                <p id="smart-answer-text" class="mb-0 text-dark" style="font-style: italic;"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                    <section id="comments-section" class="mb-5">
                        <h3 class="text-center mb-4" style="color: var(--color-dark-bg);">Join the Conversation</h3>
                        
                        <div id="disqus_thread"></div>
                        <script>
                            var disqus_config = function () {
                                this.page.url = '{{ request.url }}';
                                this.page.identifier = 'blog-{{ post.id }}';
                            };
                            
                            (function() {
                                var d = document, s = d.createElement('script');
                                s.src = 'https://superprompterai.disqus.com/embed.js';
                                s.setAttribute('data-timestamp', +new Date());
                                (d.head || d.body).appendChild(s);
                            })();
                        </script>
                        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                    </section>

                    <section id="subscription-cta" class="p-4 mb-5 text-center" style="background-color: #f0f2f5; border-radius: 8px;">
                        <h4 style="color: var(--color-dark-bg); margin-bottom: 15px;">Stay Updated!</h4>
                        <p class="lead">Stay updated with the latest AI prompt generation tips, news, and features.</p>
                        <a href="https://flow.cleverreach.com/fl/f1b39182-4b74-4664-9c1d-c175cb3a670c/" target="_blank" class="btn btn-primary btn-lg">Share Your Email ID</a>
                    </section>

                    <div class="mt-5 pt-3 border-top text-center">
                        <a href="{{ url_for('all_news') }}" class="btn btn-primary">Back to All News</a>
                    </div>

                </div>
            </div> 
            
        </div>
    </div> 
    
    {# *** FIX 1: The misplaced closing tags are fixed here: *** #}
    {# The missing </div> tags for post-container-main, col-md-9, row, and container are now correctly implied to be outside of the main structure #}
    
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. SHARED UTILITIES ---

    // Removes *, # but keeps emojis
    function cleanText(text) {
        if (!text) return "";
        return text.replace(/[*#]/g, '').trim();
    }

    // Single Shared Typewriter Effect
    function typeWriter(text, target, i, callback) {
        const cleanStr = cleanText(text); 
        if (i < cleanStr.length) {
            target.innerHTML += cleanStr.charAt(i);
            setTimeout(() => typeWriter(cleanStr, target, i + 1, callback), 15);
        } else if (callback) {
            callback();
        }
    }

    // --- 2. COPY LINK LOGIC ---
    const copyButton = document.getElementById('copy-link-btn'); 
    const originalText = 'Copy Link';

    if (copyButton) {
        copyButton.addEventListener('click', async () => {
            const linkToCopy = copyButton.getAttribute('data-url'); 
            if (navigator.clipboard && window.isSecureContext) {
                try {
                    await navigator.clipboard.writeText(linkToCopy);
                    showCopySuccessFeedback(copyButton, originalText);
                } catch (err) {
                    fallbackCopyTextToClipboard(linkToCopy, copyButton, originalText);
                }
            } else {
                fallbackCopyTextToClipboard(linkToCopy, copyButton, originalText);
            }
        });
    }

    function showCopySuccessFeedback(button, text) {
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.classList.replace('btn-secondary', 'btn-success');
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy"></i> ' + text;
            button.classList.replace('btn-success', 'btn-secondary');
        }, 2000);
    }

    function fallbackCopyTextToClipboard(text, button, originalText) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; textArea.style.opacity = 0;
        document.body.appendChild(textArea);
        textArea.focus(); textArea.select();
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        if (successful) showCopySuccessFeedback(button, originalText);
    }

    // --- 3. AI POST-ANALYZER LOGIC (Fixed) ---
    const analyzeBtn = document.getElementById('analyze-btn');
    const analysisResult = document.getElementById('analysis-result');

    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', function() {
            // FIX: Ensure the div is visible
            analysisResult.style.display = 'block'; 
            
            this.disabled = true;
            analysisResult.innerHTML = "<em><i class='fas fa-spinner fa-spin'></i> AI is analyzing the text...</em>";
            
            fetch(`/api/analyze-post/{{ post.id }}`)
                .then(res => res.json())
                .then(data => {
                    analysisResult.innerHTML = ""; // Clear the spinner
                    typeWriter(data.summary, analysisResult, 0, () => {
                        analyzeBtn.disabled = false; // Re-enable after typing
                    });
                })
                .catch(() => {
                    analysisResult.innerHTML = "Analysis currently unavailable.";
                    this.disabled = false;
                });
        });
    }

    // --- 4. AI SMART POLLER LOGIC ---
    const pollGenBtn = document.getElementById('poll-gen-btn');
    const pollArea = document.getElementById('poll-area');
    const pollQuestion = document.getElementById('poll-question');
    const optionsContainer = document.getElementById('poll-options-container');
    const smartAnswerBox = document.getElementById('smart-answer-box');
    const smartAnswerText = document.getElementById('smart-answer-text');

    if (pollGenBtn) {
        pollGenBtn.addEventListener('click', function() {
            this.style.display = 'none';
            pollArea.style.display = 'block';
            pollQuestion.innerHTML = "<em><i class='fas fa-robot fa-spin'></i> Designing poll...</em>";
            
            fetch(`/api/generate-blog-poll/{{ post.id }}`)
                .then(res => res.json())
                .then(data => {
                    pollQuestion.innerHTML = cleanText(data.question);
                    optionsContainer.innerHTML = "";
                    data.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = "btn btn-outline-secondary btn-sm mb-2 text-left shadow-sm";
                        btn.innerText = cleanText(opt);
                        btn.onclick = () => {
                            optionsContainer.querySelectorAll('button').forEach(b => b.disabled = true);
                            submitVote(opt, data.question);
                        };
                        optionsContainer.appendChild(btn);
                    });
                });
        });
    }

    function submitVote(choice, question) {
        smartAnswerBox.style.display = 'block';
        smartAnswerText.innerHTML = "<em>Consulting global 2025 trends...</em>";

        fetch(`/api/poll-review?choice=${encodeURIComponent(choice)}&question=${encodeURIComponent(question)}`)
            .then(res => res.json())
            .then(data => {
                smartAnswerText.innerHTML = "";
                typeWriter(data.review, smartAnswerText, 0);
            });
    }
    // --- 5. AI SIDEBAR SIDEBAR INTEGRATION ---
    const sidebarList = document.getElementById('sidebar-list');
    const sidebarHeader = document.getElementById('sidebar-header');
    const aiLoader = document.getElementById('ai-loader');

    if (sidebarList && sidebarHeader) {
        // Show the loader immediately
        aiLoader.style.display = 'block';

        fetch(`/api/recommended/{{ post.id }}`)
            .then(res => res.json())
            .then(data => {
                aiLoader.style.display = 'none';

                // Only proceed if the AI actually found relevant matches
                if (data && data.length > 0) {
                    // Update Header with an AI Sparkle
                    sidebarHeader.innerHTML = '<i class="fas fa-robot text-primary sparkle"></i> AI Recommended';
                    
                    // Clear the existing "Latest Blogs" list
                    sidebarList.innerHTML = "";

                    data.forEach((item, index) => {
                        const li = document.createElement('li');
                        // We use a slight delay for each item to make it feel "calculated"
                        li.style.opacity = "0";
                        li.style.transition = "opacity 0.5s ease";
                        
                        li.innerHTML = `
                            <a href="${item.url}" class="sidebar-link">
                                <i class="fas fa-chevron-right small mr-2 opacity-50"></i>${item.title}
                            </a>`;
                        
                        sidebarList.appendChild(li);
                        
                        // Fade in effect
                        setTimeout(() => {
                            li.style.opacity = "1";
                        }, index * 100);
                    });
                }
            })
            .catch(err => {
                console.error("AI Sidebar Error:", err);
                aiLoader.style.display = 'none';
                // Note: We don't clear the list on error so the "Latest Blogs" remain as a fallback
            });
    }
});
</script>
</body>
</html>
