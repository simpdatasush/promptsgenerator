<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latest AI News - SuperPrompter AI</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="style.css">

</head>
<body>

<header class="app-header">
    <div class="logo-section">
        <img src="https://placehold.co/40x40/007bff/ffffff?text=AI" alt="SuperPrompter Logo" class="app-logo">
        <h1 class="header-title">SuperPrompter</h1>
    </div>
    <nav class="auth-section">
            <a href="/">Home</a>
            <a href="/login">Login</a>
        </nav>
</header>

<div class="container">
    <h1 class="text-center mb-5" style="color: var(--color-dark-bg);">ðŸ“° Latest AI News</h1>

    <form method="GET" action="{{ url_for('all_news') }}" class="mb-4">
        <div class="input-group shadow-sm">
            <input type="text" id="news-search-input" class="form-control" 
                   placeholder="Search news..." name="q" value="{{ request.args.get('q', '') }}" list="autocomplete-list">
            
            <div class="input-group-append">
                <button class="btn btn-secondary" style="background-color: var(--color-secondary); border: none;" type="submit">Search</button>
                <button class="btn btn-info" id="smart-ai-btn" type="button" style="background-color: var(--color-primary); border: none;">
                    <i class="fas fa-robot"></i> Smart AI
                </button>
            </div>
        </div>
        <datalist id="autocomplete-list"></datalist>
    </form>

    <div id="ai-summary-wrapper">
        <div id="ai-summary-content" class="shadow-sm border">
            <div class="d-flex align-items-center mb-2">
                <div class="spinner-border spinner-border-sm text-primary mr-2" id="ai-loader" role="status" style="display: none;"></div>
                <strong style="color: var(--color-dark-bg); font-size: 1.1rem;">
                    <i class="fas fa-magic"></i> Smart AI Insight
                </strong>
            </div>
            <p id="ai-result-text"></p><span id="ai-cursor" class="cursor" style="display:none;"></span>
        </div>
    </div>

    {% if articles %}
    {% for article in articles %}
        <div class="article-card">
            <img src="https://loremflickr.com/100/100/ai,technology?lock={{ loop.index }}" 
                 class="article-thumb" 
                 alt="Article thumbnail" 
                 onerror="this.style.display='none'">
            
            <div class="article-body-content" style="flex: 1;">
                <h3 class="article-title">
                    {% if article.id in blog_id_tracker %}
                        <a href="#" data-toggle="modal" data-target="#blogModal" 
                           data-title="{{ article.title }}" data-content="{{ article.description }}" 
                           style="color: var(--color-primary); text-decoration: none; font-weight: 600;">
                            <i class="fas fa-book-open" style="font-size: 0.9em;"></i> {{ article.title }} <small>(*)</small>
                        </a>
                    {% else %}
                        <a href="{{ article.source_url }}" target="_blank" style="color: var(--color-dark-bg); text-decoration: none; font-weight: 600;">
                            {{ article.title }} <i class="fas fa-external-link-alt" style="font-size: 0.8em;"></i>
                        </a>
                    {% endif %}
                </h3>

                <p style="color: #444; margin-bottom: 10px;">{{ article.summary | truncate(200) }}</p>

                <div class="article-meta" style="color: var(--color-text-muted); font-size: 0.85rem;">
                    <span><i class="fas fa-calendar-alt"></i> {{ article.date_published.strftime('%b %d, %Y') }}</span>
                    {% if article.share_url %}
                    <button type="button" class="btn btn-sm btn-outline-secondary copy-link-btn" data-url="{{ article.share_url }}" style="margin-left: 10px; padding: 2px 8px; font-size: 0.75rem;">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
{% endif %}

        <div class="d-flex justify-content-center mt-5">
            <nav>
                <ul class="pagination">
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for(request.endpoint, page=pagination.prev_num, q=request.args.get('q', '')) if pagination.has_prev else '#' }}">Previous</a>
                    </li>

                    {% for p in pagination.iter_pages() %}
                        {% if p %}
                            <li class="page-item {% if p == pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for(request.endpoint, page=p, q=request.args.get('q', '')) }}">{{ p }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
                        {% endif %}
                    {% endfor %}

                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for(request.endpoint, page=pagination.next_num, q=request.args.get('q', '')) if pagination.has_next else '#' }}">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            No news articles found. 
            {% if request.args.get('q') %} for "{{ request.args.get('q') }}"{% endif %}
        </div>
    {% endif %}
</div>


<div class="modal fade" id="blogModal" tabindex="-1" role="dialog" aria-labelledby="blogModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blogModalLabel">In-App Article</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h3 id="modal-title" class="mb-4"></h3>
                <div id="modal-content-body" style="white-space: pre-wrap; font-size: 1.1rem;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Smart AI Logic (Typewriter & Dynamic Expansion) ---
        const smartAiBtn = document.getElementById('smart-ai-btn');
        const aiWrapper = document.getElementById('ai-summary-wrapper');
        const aiResultText = document.getElementById('ai-result-text');
        const aiLoader = document.getElementById('ai-loader');
        const aiCursor = document.getElementById('ai-cursor');
        const searchInput = document.getElementById('news-search-input');

        smartAiBtn.addEventListener('click', function() {
            const query = searchInput.value.trim();
            if (!query) {
                alert("Please enter a search term first.");
                return;
            }

            // Show container and loading state
            aiWrapper.style.maxHeight = "500px"; 
            aiWrapper.style.marginBottom = "30px";
            aiLoader.style.display = "inline-block";
            aiResultText.innerHTML = "<em>Analyzing database and generating smart summary...</em>";
            aiCursor.style.display = "none";

            fetch(`/api/ai-summary?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    aiLoader.style.display = "none";
                    aiResultText.innerHTML = ""; // Clear loader text
                    aiCursor.style.display = "inline-block";
                    
                    // Start Typewriter effect
                    typeWriter(data.summary, aiResultText, 0, () => {
                        aiCursor.style.display = "none"; // Hide cursor when finished
                    });
                })
                .catch(err => {
                    aiLoader.style.display = "none";
                    aiResultText.innerText = "Smart AI is currently unavailable. Showing standard results below.";
                });
        });

        function typeWriter(text, target, i, callback) {
            if (i < text.length) {
                target.innerHTML += text.charAt(i);
                setTimeout(() => typeWriter(text, target, i + 1, callback), 25);
            } else if (callback) {
                callback();
            }
        }

        // --- 2. Autocomplete Logic ---
        const dataList = document.getElementById('autocomplete-list');
        const API_URL = '{{ url_for("news_autocomplete") }}'; 
        let typingTimer;
        const doneTypingInterval = 300;

        searchInput.addEventListener('keyup', () => {
            clearTimeout(typingTimer);
            if (searchInput.value.length >= 2) {
                typingTimer = setTimeout(fetchSuggestions, doneTypingInterval);
            } else {
                dataList.innerHTML = '';
            }
        });

        function fetchSuggestions() {
            const query = searchInput.value;
            fetch(API_URL + '?q=' + encodeURIComponent(query))
                .then(response => response.json())
                .then(data => {
                    dataList.innerHTML = ''; 
                    data.forEach(suggestion => {
                        const option = document.createElement('option');
                        option.value = suggestion;
                        dataList.appendChild(option);
                    });
                });
        }

        // --- 3. Clipboard / Copy Link Logic ---
        const copyButtons = document.querySelectorAll('.copy-link-btn');
        copyButtons.forEach(btn => {
            const originalHTML = btn.innerHTML;
            btn.addEventListener('click', async function() {
                const url = this.getAttribute('data-url');
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(url);
                    showSuccess(this, originalHTML);
                } else {
                    fallbackCopy(url, this, originalHTML);
                }
            });
        });

        function showSuccess(btn, oldHtml) {
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.classList.replace('btn-outline-secondary', 'btn-success');
            setTimeout(() => {
                btn.innerHTML = oldHtml;
                btn.classList.replace('btn-success', 'btn-outline-secondary');
            }, 2000);
        }

        function fallbackCopy(text, btn, oldHtml) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showSuccess(btn, oldHtml);
        }
    });

    // --- 4. Modal Logic (jQuery) ---
    $('#blogModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        modal.find('#modal-title').text(button.data('title'));
        modal.find('#modal-content-body').text(button.data('content'));
    });
</script>
    
</body>
</html>
